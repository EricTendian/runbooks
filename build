#!/usr/bin/env python3.6
import argparse
import os.path
import subprocess
from typing import NoReturn


HERE = os.path.abspath(os.path.dirname(__file__))


def main() -> NoReturn:
    parser = argparse.ArgumentParser()
    parser.add_argument('--source', action='store_true')
    parser.add_argument('--unsigned', action='store_true')
    args = parser.parse_args()

    print('*' * 79)
    print('Parsing target distribution')
    print('*' * 79)
    dist = subprocess.check_output((
        'dpkg-parsechangelog', '--show-field=distribution',
        '--file=debian/changelog',
    )).decode().strip()

    tag = f'{dist}-deadsnakes'
    print('*' * 79)
    print(f'Building image (tag: {tag})')
    print('*' * 79)
    with open(os.path.join(HERE, f'dockerfiles/Dockerfile.{dist}'), 'rb') as f:
        subprocess.check_call(('docker', 'build', '-t', tag, '-'), stdin=f)

    print('*' * 79)
    print('Running build (results will be in ../dist)')
    print('*' * 79)
    os.makedirs('../dist', exist_ok=True)
    pwd = os.getcwd()
    home = os.environ['HOME']
    gbp_args = '-us -uc' if args.unsigned else ''
    extra = '--git-builder="debuild -S"' if args.source else ''
    prog = (
        f'cp -r /code /tmp && '
        f'cd /tmp/code && '
        f'mk-build-deps --install --remove --tool "apt-get --yes" debian/control && '  # noqa
        f'gbp buildpackage {gbp_args} --git-pristine-tar --git-debian-branch=ubuntu/{dist} {extra} && '  # noqa
        f'cp ../* /dist'
    )
    cmd = (
        'docker', 'run', '--rm', '-ti',
        '-v', f'{pwd}:/code:ro',
        '-v', f'{pwd}/../dist:/dist:rw',
        '-v', f'{home}/.gnupg/pubring.gpg:/root/.gnupg/pubring.gpg:ro',
        '-v', f'{home}/.gnupg/secring.gpg:/root/.gnupg/secring.gpg:ro',
        tag, 'bash', '-euxc', prog,
    )
    os.execvp(cmd[0], cmd)
    raise SystemError('https://github.com/python/typeshed/pull/2226')


if __name__ == '__main__':
    exit(main())
